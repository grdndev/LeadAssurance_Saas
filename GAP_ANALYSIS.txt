====================================================
GAP ANALYSIS — LeadsAssurance.com
CDC vs. Workspace (19/02/2026) — Updated Pass 5 (Full RDV Workflow)
====================================================

----------------------------------------------------
SECTION 1 — VISION & OBJECTIFS
----------------------------------------------------

IMPLÉMENTÉ :
✅ Achat de leads qualifiés via la salle de marché (marketplace)
✅ Consentement accessible sur chaque lead (preuve PDF exportable)
✅ Fraîcheur visible sur la marketplace (badge "ultra-frais", "frais", etc.)
✅ Conformité RGPD : consentement explicite, IP, user-agent, URL source, horodatage
✅ Hash SHA-256 (proofHash) calculé à la soumission (submit, leads/route.ts, import CSV)

MANQUANT :
⚠️  Transparence des prix côté front public (page /tarifs à vérifier)


----------------------------------------------------
SECTION 2 — CATALOGUE PRODUITS (18 produits)
----------------------------------------------------

IMPLÉMENTÉ :
✅ 18 produits définis dans lib/constants/products.ts avec champs, prix, catégories
✅ Pages formulaires lead individuelles pour les 18 produits :
   ASSURANCE_AUTO, ASSURANCE_HABITATION, ASSURANCE_CHIENS_CHATS,
   ASSURANCE_OBSEQUES, ASSURANCE_VIE_RETRAITE, DEFISCALISATION,
   DOMMAGE_OUVRAGE, MULTIRISQUE_IMMEUBLE, MULTIRISQUE_PROFESSIONNELLE,
   PREVOYANCE_TNS, RC_DECENNALE, RC_PRO,
   CREDIT_IMMO, RACHAT_CREDIT, CREDIT_PRO, ASSURANCE_EMPRUNTEUR,
   MUTUELLE_SANTE_IND, MUTUELLE_ENTREPRISE  (ajoutés en Pass 2)

MANQUANT / INCOMPLET :
⚠️  MUTUELLE_SANTE_IND : le CDC demande "âge de(s) assuré(s)" (pluriel).
    Le formulaire recueille un seul champ "age" — acceptable pour MVP.


----------------------------------------------------
SECTION 3 — CHAMPS COMMUNS OBLIGATOIRES
----------------------------------------------------

IMPLÉMENTÉ :
✅ Prénom, Nom, Téléphone, Email, Code postal, Ville — tous dans le modèle Lead
✅ Consentement : case non pré-cochée, texte, horodatage, IP, user-agent, URL source
✅ Versioning du consentement : champ consentVersion @default("1.0") dans Consent

MANQUANT :
⚠️  Certains formulaires provider passent "manual_injection" comme urlSource.
    Acceptable pour l'espace apporteur.


----------------------------------------------------
SECTION 4 — CHAMPS OBLIGATOIRES PAR PRODUIT
----------------------------------------------------

✅ Tous les 18 produits ont leurs champs CDC définis dans products.ts et
   dans les formulaires dédiés.


----------------------------------------------------
SECTION 5 — RDV QUALIFIÉS (CPRDV)
----------------------------------------------------

IMPLÉMENTÉ :
✅ Modèle DB Lead : leadType, appointmentDate, appointmentChannel (PHONE/VISIO),
   appointmentStatus, availabilities, confirmationSentAt, isAppointment
✅ Formulaire soumission apporteur avec toggle Lead/RDV  ← Pass 5
   - Sélection canal PHONE/VISIO (obligatoire pour RDV)
   - Date souhaitée + créneaux de disponibilité multiples (ajout/suppression dynamique)
   - Texte de consentement renforcé spécifique aux RDV
   - Prix automatique (appointmentPrice) selon le produit
   - Filtre produits : seuls les produits hasAppointment=true sont proposés en mode RDV
   - API /api/leads/submit étendue : leadType, appointmentChannel, appointmentDate,
     availabilities, appointmentStatus=PENDING, prix appointmentPrice  ← Pass 5
✅ Filtre "RDV Qualifiés" sur la marketplace  ← Pass 5
   - Bouton "RDV Qualifiés" dans les filtres (distinct des leads classiques)
   - Carte marketplace : badge canal (PHONE/VISIO), date souhaitée si renseignée
   - Badge "RDV" violet distinct du badge "Ultra-Frais"
   - Stats bar : compteur RDV qualifiés distincts des leads classiques
   - API /api/marketplace/leads expose leadType, appointmentChannel, appointmentDate
✅ Section "Mes RDV" dédiée dans le dashboard courtier  ← Pass 5
   - Page /dashboard/appointments avec liste des RDV achetés
   - Filtres statut (En attente / Confirmé / Annulé) + recherche
   - Stats : total / en attente / confirmés / annulés
   - Affichage : canal, date souhaitée, créneaux de disponibilité
   - Actions : Confirmer / Annuler le RDV (boutons inline)
   - Accès preuve de consentement renforcé + export PDF
   - Lien "Mes RDV" dans la sidebar courtier
   - Bouton "Mes RDV Qualifiés" dans la page de tableau de bord
✅ API PATCH /api/user/leads/[id]/appointment  ← Pass 5
   - Met à jour appointmentStatus (CONFIRMED/CANCELLED)
   - Enregistre confirmationSentAt à la confirmation
   - Envoie email de notification de changement de statut au courtier
   - Audit log BROKER_STATUS_CHANGED avec context leadType=APPOINTMENT
✅ Emails post-achat RDV différenciés  ← Pass 5
   - emailTemplates.appointmentPurchased : courtier après achat RDV
   - emailTemplates.appointmentSold : apporteur après vente RDV
   - emailTemplates.appointmentStatusChanged : courtier lors de confirmation/annulation

MANQUANT :
⚠️  SMS de confirmation RDV (Twilio non configuré — email seul)
    → Acceptable : email de confirmation envoyé via lib/mail.ts + Resend


----------------------------------------------------
SECTION 6 — SALLE DE MARCHÉ
----------------------------------------------------

IMPLÉMENTÉ :
✅ Mise en stock des leads validés (status=STOCK)
✅ Achat à l'unité avec système de crédits
✅ Réservation temporaire pendant le paiement (MarketplaceReservation, 10 min)
✅ Infos visibles avant achat : produit, zone (CP masqué), fraîcheur, prix
✅ Consentement accessible après achat (badge ✔ visible, dialog + PDF)
✅ Accès public sans connexion (visualisation uniquement)
✅ Filtre par fraîcheur (< 24h / < 48h / < 72h)  ← Pass 3
✅ Filtres catégorie + type produit + code postal

MANQUANT :
❌ Paiement direct par CB (uniquement via recharge de crédits Stripe)
⚠️  Filtre "RDV" implémenté en Pass 5 — complété


----------------------------------------------------
SECTION 7 — ESPACE COURTIER
----------------------------------------------------

IMPLÉMENTÉ :
✅ Tableau de bord avec stats
✅ Liste des leads achetés (dashboard/leads) avec filtres et recherche
✅ Fiche détaillée par lead : page /dashboard/leads/[id]  ← Pass 3
✅ Changement de statut CRM : Contacté / Converti / Perdu (dropdown)  ← Pass 2
✅ Motif de perte optionnel (liste + saisie libre)  ← Pass 2
✅ Filtre leads par statut CRM (bug filtre "Nouveau" corrigé)  ← Pass 3
✅ Preuve de consentement + export PDF (liste ET fiche détail)
✅ Salle de marché accessible (dashboard/marketplace)
✅ Crédits & facturation (dashboard/billing) avec historique
✅ Section "Mes RDV" dédiée /dashboard/appointments  ← Pass 5
✅ Confirmation/annulation RDV inline avec email de notification  ← Pass 5

MANQUANT :
❌ Confirmation SMS après achat RDV (Twilio non intégré)


----------------------------------------------------
SECTION 8 — ESPACE APPORTEUR (PROVIDER)
----------------------------------------------------

IMPLÉMENTÉ :
✅ Soumission manuelle de leads (dashboard/provider/submit)
✅ Toggle Lead/RDV sur le formulaire provider  ← Pass 5
   - Mode RDV : champs canal PHONE/VISIO, date, créneaux disponibilité
   - Consentement renforcé spécifique RDV
   - Prix appointmentPrice auto-sélectionné
   - Filtre produits compatibles RDV (hasAppointment=true)
✅ Import CSV : route API + bouton upload UI dans le dashboard provider  ← Pass 3
✅ Consentement obligatoire sur la soumission
✅ Validation automatique des champs requis
✅ Reporting (stats : acceptés, vendus, en attente, revenus)
✅ Liste des leads soumis avec statut et filtre
✅ Motifs de rejet affichés à l'apporteur (rejectionReason DB + UI)  ← Pass 2
✅ Notification apporteur quand lead approuvé ou rejeté  ← Pass 3
✅ proofHash calculé à la soumission manuelle et CSV  ← Pass 2/3
✅ Reporting refusés : badge compteur refusés dans la liste, motif visible  ← Pass 4
✅ API externe apporteur sécurisée par API key :  ← Pass 4
   - Modèle ApiKey (DB : id, userId, name, key SHA-256, prefix, lastUsedAt, active)
   - GET/POST/DELETE /api/user/provider/apikeys (liste, création, révocation)
   - POST /api/v1/leads (endpoint public authentifié par Bearer API key)
   - Page dashboard/provider/apikeys avec doc intégrée + affichage unique de la clé
   - Lien "Clés API" dans la sidebar provider

MANQUANT :
❌ Rejet automatique avec règles configurables (doublons, champs manquants)


----------------------------------------------------
SECTION 9 — CONFORMITÉ & CONSENTEMENT
----------------------------------------------------

IMPLÉMENTÉ :
✅ Consentement explicite obligatoire sur tous les formulaires
✅ Texte de consentement stocké par lead
✅ Date/heure, IP publique, user-agent, URL source stockés
✅ Versioning du consentement (consentVersion @default("1.0"))
✅ Hash SHA-256 (proofHash) calculé et stocké sur tous les chemins de création
✅ Preuve consultable (courtier : liste + fiche détail /leads/[id])
✅ Preuve consultable côté apporteur (dialog détail dans provider/leads)  ← Pass 4
✅ Export PDF de preuve (ConsentPDF via @react-pdf/renderer)
✅ Consentement lié à chaque lead (relation Consent ↔ Lead 1-to-1)
✅ Export PDF disponible côté apporteur dans le dialog détail  ← Pass 4


----------------------------------------------------
SECTION 10 — AUDIT LOG
----------------------------------------------------

IMPLÉMENTÉ :
✅ Modèle AuditLog en base (userId, action, entityType, entityId, details, ip)  ← Pass 3
✅ lib/audit.ts avec writeAuditLog() helper non-bloquant (jamais bloquant)
✅ Journalisé sur : LEAD_APPROVED, LEAD_REJECTED, LEAD_PURCHASED,
                    BROKER_STATUS_CHANGED  ← Pass 3
✅ Journalisé sur : LEAD_SUBMITTED (submit manuel + API key)  ← Pass 4
✅ Journalisé sur : CREDIT_RECHARGED (stripe webhook)  ← Pass 4
✅ Journalisé sur : USER_REGISTERED (register route)  ← Pass 4
✅ Journalisé sur : DISPUTE_RESOLVED (admin disputes PATCH)  ← Pass 4
✅ Interface admin pour consulter les logs d'audit :  ← Pass 4
   - Onglet "Audit Log" dans l'admin dashboard
   - GET /api/admin/audit avec pagination
   - Couleurs par type d'action, détails JSON, IP, timestamps
   - Activité récente affichée dans l'onglet "Vue d'ensemble"


----------------------------------------------------
SECTION 11 — NOTIFICATIONS
----------------------------------------------------

IMPLÉMENTÉ :
✅ Modèle Notification en base
✅ lib/notifications.ts : notifyLeadPurchased, notifyLeadSold, notifyCreditLow,
   notifyDisputeOpened, notifyLeadApproved, notifyLeadRejected
✅ Déclenchement : achat lead (courtier + apporteur), crédits faibles
✅ Déclenchement : approbation/rejet admin → notification apporteur  ← Pass 3
✅ NotificationCenter dans le dashboard (cloche)

MANQUANT :
❌ Notification temps-réel (WebSocket / SSE) — actuellement polling uniquement


----------------------------------------------------
SECTION 12 — RÉCAPITULATIF MVP (ÉTAT ACTUEL)
----------------------------------------------------

MVP COMPLET ✅ :
- Catalogue 18 produits avec 18 formulaires dédiés
- Salle de marché : achat, réservation, filtres catégorie/produit/fraîcheur/CP/RDV
- CRM courtier : liste, fiche /[id], CRM statuts, motif perte, consentement PDF
- CRM apporteur : soumission manuelle + RDV + import CSV + stats + motifs refus + badge refusés
- Consentement RGPD : IP, UA, URL, timestamp, texte, version, proofHash SHA-256, PDF
- Consentement renforcé RDV : texte spécifique, accessible côté apporteur et courtier
- Système de crédits + recharge Stripe
- Notifications in-app (achat, vente, crédits bas, approbation, rejet)
- Admin : modération leads avec motif rejet (dialog) + notifications apporteur
- Audit log immuable : 8 actions journalisées + interface admin dédiée  ← Pass 4
- API key provider : génération, révocation, endpoint public /api/v1/leads  ← Pass 4
- RDV qualifiés complet  ← Pass 5 :
  - Formulaire apporteur toggle Lead/RDV avec canal, date, créneaux, consentement renforcé
  - API submit étendue : leadType APPOINTMENT, appointmentChannel, availabilities
  - Marketplace : filtre RDV, badge canal/date sur les cartes, stats RDV
  - Page courtier /dashboard/appointments dédiée
  - Actions broker : Confirmer / Annuler avec email + audit log
  - API PATCH /api/user/leads/[id]/appointment
  - Emails différenciés : achat RDV, vente RDV, changement statut
  - Lien sidebar + bouton dashboard "Mes RDV"

À FAIRE ❌ (priorité basse / post-MVP) :
1. Achat direct CB sur la marketplace (sans recharge préalable)
2. Rejet automatique avec règles configurables (doublons, champs manquants)
3. Notifications temps-réel (WebSocket/SSE)
4. SMS de confirmation RDV (Twilio)
